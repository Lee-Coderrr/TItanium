apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: titanium-local
  annotations:
    titanium.io/environment: local
    titanium.io/purpose: development
    titanium.io/maintainer: development-team

# ğŸ”¥ namespace.yaml ì¶”ê°€
resources:
- ../../base
- namespace.yaml              # â† Namespace ë¦¬ì†ŒìŠ¤ ì¶”ê°€

# í™˜ê²½ë³„ labels
labels:
- pairs:
    environment: local
    tier: development
    titanium.io/cost-center: development
    titanium.io/debug-mode: "true"
  includeSelectors: false
  includeTemplates: true

# í™˜ê²½ë³„ annotations
commonAnnotations:
  titanium.io/debug-enabled: "true"
  titanium.io/resource-profile: minimal
  titanium.io/monitoring: disabled
  dev.titanium.io/hot-reload: "true"

namePrefix: local-
nameSuffix: -dev
namespace: titanium-local

# ë¡œì»¬ ê°œë°œìš© ë‚®ì€ replica ì„¤ì •
replicas:
- name: api-gateway-deployment
  count: 1
- name: auth-service-deployment
  count: 1
- name: dashboard-ui-deployment
  count: 1
- name: load-balancer-deployment
  count: 1
- name: user-service-deployment
  count: 1
- name: redis-deployment
  count: 1

# ğŸ”¥ (ë¦¬íŒ©í† ë§) ë¡œì»¬ ê°œë°œìš© :dev ì´ë¯¸ì§€ íƒœê·¸ ì‚¬ìš©
images:
- name: dongju101/titanium-api
  newTag: dev
- name: dongju101/titanium-auth-service
  newTag: dev
- name: dongju101/titanium-ui
  newTag: dev
- name: dongju101/titanium-lb
  newTag: dev
- name: dongju101/titanium-user-service
  newTag: dev
- name: redis
  newTag: 7-alpine # redisëŠ” ê³µì‹ ì´ë¯¸ì§€ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©

# ë¡œì»¬ í™˜ê²½ìš© ConfigMap ì„¤ì •
configMapGenerator:
- name: app-config
  behavior: merge
  literals:
  - LOAD_BALANCER_URL=http://local-load-balancer-service-dev:7100
  - API_GATEWAY_URL=http://local-api-gateway-service-dev:8000
  - DASHBOARD_UI_URL=http://local-dashboard-ui-service-dev:80
  - USER_SERVICE_URL=http://local-user-service-dev:8001
  - AUTH_SERVICE_URL=http://local-auth-service-dev:8002
  - ENVIRONMENT=local
  - LOG_LEVEL=DEBUG
  - LOG_FORMAT=pretty
  - DEBUG_MODE=true
  - METRICS_ENABLED=false
  - TRACING_ENABLED=false
  - CORS_ALLOWED_ORIGINS=*
  - RATE_LIMIT_ENABLED=false
  - PROMETHEUS_ENABLED=false
  - JAEGER_ENABLED=false
  - HEALTH_CHECK_INTERVAL=60
  - REDIS_TIMEOUT=10000
  - TOKEN_EXPIRY=7200
  - REFRESH_TOKEN_EXPIRY=172800

# ë¡œì»¬ í™˜ê²½ìš© Secret
secretGenerator:
- name: app-secrets
  behavior: merge
  literals:
  - INTERNAL_API_SECRET=bG9jYWwtZGV2LXNlY3JldC1rZXktMjAyNA==
  - JWT_SECRET_KEY=bG9jYWwtand0LXNlY3JldC1mb3ItZGV2ZWxvcG1lbnQ=
  - DB_ENCRYPTION_KEY=bG9jYWwtZGIta2V5
  - REDIS_PASSWORD=

patches:
# (NodePortë¡œ ë³€ê²½í•˜ëŠ” ì„œë¹„ìŠ¤ íŒ¨ì¹˜ëŠ” ì´ì „ê³¼ ë™ì¼)
- target:
    kind: Service
    name: load-balancer-service
  patch: |-
    - op: replace
      path: /spec/type
      value: NodePort
    - op: add
      path: /spec/ports/0/nodePort
      value: 30700
- target:
    kind: Service
    name: api-gateway-service
  patch: |-
    - op: replace
      path: /spec/type
      value: NodePort
    - op: add
      path: /spec/ports/0/nodePort
      value: 30800

# ë¡œì»¬ í™˜ê²½ ìµœì í™” íŒ¨ì¹˜ íŒŒì¼ í¬í•¨
- path: patches.yaml

# ë¡œì»¬ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ImagePullPolicy ë³€ê²½
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: IfNotPresent
  target:
    kind: Deployment
    name: ".*-deployment" # ì •ê·œì‹ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  Deploymentì— ì ìš©

replacements:
- source:
    # ğŸƒ ì†ŒìŠ¤(Source): ì´ë¦„ì´ 'redis-service'ì¸ Service ë¦¬ì†ŒìŠ¤ì—ì„œ
    kind: Service
    name: redis-service
    # ğŸ¯ í•„ë“œ ê²½ë¡œ(Field Path): 'metadata.name' ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    # (Kustomizeê°€ ë¹Œë“œ ê³¼ì •ì—ì„œ 'local-redis-service-dev' ë¼ëŠ” ìµœì¢… ì´ë¦„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤)
    fieldPath: metadata.name
  targets:
  - select:
      # ğŸƒ íƒ€ê²Ÿ(Target): 'app-config'ë¼ëŠ” ì´ë¦„ì˜ ConfigMapì„ ì„ íƒí•˜ì—¬
      kind: ConfigMap
      name: app-config
    # ğŸ¯ í•„ë“œ ê²½ë¡œ(Field Path): 'data.REDIS_HOST' í•„ë“œì— ìœ„ì—ì„œ ê°€ì ¸ì˜¨ ê°’ì„ ì£¼ì…í•©ë‹ˆë‹¤.
    fieldPaths:
    - data.REDIS_HOST